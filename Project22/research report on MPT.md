# research report on MPT

## Merkle Patricia Tree

Merkle Patricia Tree（也称为Merkle Patricia Trie）是一种数据结构，融合了Merkle tree和前缀树两种树结构的优点，并进行改良，是以太坊中用于组织和管理账户数据、生成交易集合哈希的重要数据结构。

MPT树的作用如下：

1. 存储任意长度的key-value键值对数据，符合以太坊的state模型；
2. 提供了一种快速计算所维护数据集哈希标识的机制；
3. 提供了快速状态回滚的机制；
4. 提供了一种称为默克尔证明的证明方法，用于轻节点的扩展，实现简单支付验证。

MPT结合了Radix trie和Merkle两种树结构的特点和优势，因此在介绍MPT之前，我们首先简要介绍了这两种树结构的特点,Merkle树在Project5中已经介绍并且实现过，因此在这里不多作介绍。

## Trie树

Trie树，又称**前缀树或字典树**，是一种有序树，用于保存关联数组。其中的键通常是字符串。与二叉查找树不同，键不是直接保存在节点中，而是由节点在树中的位置决定 。一个节点的所有子孙都有相同的前缀，也就是这个节点对应的字符串，而 根节点对应空字符串。

一般情况下，不是所有的节点都有对应的值，只有叶子节点和部分内部节点所对应的键才有相关的值。实际上trie每个节点是一个确定长度的数组，数组中每个节点的值是一个指向子节点的指针，最后有个标志域，标识这个位置为止是否是一个完整的字符串.

常见的用来存英文单词的trie每个节点是一个长度为27的指针数组，index0-25代表a-z字符，26为标志域。

###### 优势**：**

相比于哈希表，使用前缀树来进行查询拥有共同前缀key的数据时十分高效，例如在字典中查找前缀为pre的单词，对于哈希表来说，需要遍历整个表，时间效率为O(n)，然而对于前缀树来说，只需要在树中找到前缀为pre的节点，且遍历以这个节点为根节点的子树即可。

但是对于最差的情况（前缀为空串)，时间效率为O(n),仍然需要遍历整棵树，此时效率与哈希表相同。

相比于哈希表，在前缀树不会存在哈希冲突的问题。

###### 劣势**：**

- 直接查找效率低下 前缀树的查找效率是O(m)，m为所查找节点的key长度，而哈希表的查找效率为O(1)。且一次查找会有m次IO开销，相比于直接查找，无论是速率、还是对磁盘的压力都比较大。
- 可能会造成空间浪费 当存在一个节点，其key值内容很长（如一串很长的字符串），当树中没有与他相同前缀的分支时，为了存储该节点，需要创建许多非叶子节点来构建根节点到该节点间的路径，造成了存储空间的浪费。