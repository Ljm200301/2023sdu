# 实现方式：
椭圆曲线上点的加法运算：  
若 $P \neq Q$ ， $\lambda = ((y_2 - y_1) \cdot (x_2 - x_1)^{-1}) \mod p$ ， $x_3 = (\lambda^2 - x_1 - x_2) \mod p$ ， $y_3 = (\lambda \cdot (x_1 - x_3) - y_1) \mod p$ 。  
若 $P = Q$ ， $\lambda = ((3 \cdot x_1^2 + a) \cdot (2 \cdot y_1)^{-1}) \mod p$ ， $x_3 = (\lambda^2 - 2 \cdot x_1) \mod p$ ，$y_3 = (\lambda \cdot (x_1 - x_3) - y_1) \mod p$ 。  
椭圆曲线上点的标量倍乘：
将$k$表示为二进制形式，从高位到低位依次处理，若第 $i$ 位为1，则将点 $P$ 与 $2^{i-1}$ 倍点相加：  
$$Q = kP = \sum_{i=0}^{n-1} k_i2^iP$$  
其中，$k_i$为$k$的二进制表示的第$i$位，$n$为$k$的二进制表示的位数。


## SM2签名
SM2签名算法：
（1）生成私钥和公钥：选择一个随机数 $da$ 作为私钥，计算公钥 $Pa = da \cdot G$ ，其中 $G$ 为椭圆曲线上的基点。  
（2）签名：对于消息 $m$ ，首先计算 $m_1 = Za || m$ ，其中 $Za$ 为 $m_1$ 的哈希值。选择一个随机数 $k$ ，并计算椭圆曲线上的点 $(x_1, y_1) = k \cdot G$ 。计算 $r = (e + x_1) \mod n$ ，其中 $e$ 为 $m_1$ 的哈希值， $n$ 为曲线上点的个数。若 $r=0$ 或 $r+k=n$ ，则重新选择 $k$ 。计算 $s = ((1 + da)^{-1} \cdot (k - r \cdot da)) \mod n$ 。若 $s=0$ ，则重新选择 $k$ 。最终的签名为 $(r, s)$ 。  
（3）验证：对于签名 $(r, s)$ 和消息 $m$ ，首先计算 $m_1 = Za || m$ ，其中 $Za$ 为 $m_1$ 的哈希值。计算 $t = (r + s) \mod n$ 。计算椭圆曲线上的点 $(x_1, y_1) = s \cdot G + t \cdot Pa $。计算 $e' = Hash(Za || m)$ ，计算 $R' = (e' + x_1) \mod n$ 。若 $R'=r$ ，则签名有效，否则无效。  
其中， $Hash$ 函数使用了SM3哈希算法。
## SM2加密
### SM2加密过程：

输入：明文消息  $m$  

输出：密文分量 $c_1$ 、 $c_2$ 和 $c_3$ 

将明文消息 $m$ 转换为二进制字符串 $m_{bin}$ 。

用 $0$ 填充 $m_{bin}$ ，使其长度为 $4$ 的倍数。

生成一个随机数 $k$ ，并计算椭圆曲线上的点 $(x_1, y_1) = k \cdot G$ ，其中 $G$ 为椭圆曲线上的基点。

计算公钥 $P_a = d_a \cdot G$ ，其中 $d_a$ 为私钥。

计算椭圆曲线上的点 $(x_2, y_2) = k \cdot P_a$ ，将 $(x_2, y_2)$ 转换为二进制字符串 $x_{2bin}$和$y_{2bin}$ 。

调用KDF函数，从 $(x_{2bin} + y_{2bin})$ 生成一个长度为 $\operatorname{len}(m_{bin})$ 的二进制字符串 $t$ 。

将 $m_{bin}$ 与 $t$ 进行异或运算，得到密文 $c_2$ 。

计算密文的认证标签 $c_3 = Hash(x_{2bin} + m_{bin} + y_{2bin})$ ，其中 $Hash$ 函数采用了SM3哈希算法。

返回密文分量 $c_1$ 、 $c_2$ 和 $c_3$ ，其中 $c_1$ 为公钥坐标 $(x_1, y_1)$ 的十六进制字符串， $c_2$ 为密文的十六进制字符串， $c_3$ 为认证标签的十六进制字符串。

### SM2解密过程：

输入：密文分量 $c_1$ 、 $c_2$ 和 $c_3$ 

输出：解密后的明文消息 $m$ 

从 $c_1$ 中解析出公钥坐标 $(x_1, y_1)$。 

验证公钥坐标是否在椭圆曲线上。

计算椭圆曲线上的点 $(x_2, y_2) = d_a \cdot (x_1, y_1)$ 。

将 $(x_2, y_2)$ 转换为二进制字符串 $x_{2bin}$ 和 $y_{2bin}$ 。

调用KDF函数，从 $(x_{2bin}+ y_{2bin})$ 生成一个长度为 $\operatorname{len}(c_2) \cdot 4$ 的二进制字符串 $t$ 。

将密文 $c_2$ 与 $t$ 进行异或运算，得到二进制字符串 $m_{bin}$ 。

计算密文的认证标签 $u = Hash(x_{2bin} + m_{bin} + y_{2bin})$ 。

验证 $c_3$ 是否等于 $u$ 。

将 $m_{bin}$ 转换为十六进制字符串，再将其转换为明文消息 $m$ 。

返回明文消息 $m$ 。

其中， $d_a$ 为私钥， $G$ 为椭圆曲线上的基点， $a$ 、 $b$ 和 $p$ 为椭圆曲线的参数。

# 实现效果

